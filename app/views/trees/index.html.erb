<% provide(:title, "Phylotastic Jobs") %>

<table class="table table-striped table-hover">
  <thead> 
    <tr> 
      <th>Id</th> 
      <th>Content of tree</th> 
      <th>Status</th> 
      <th>Available actions</th>
    </tr> 
  </thead>
  <tbody> 
    <% @trees.each do |t| %>
      <tr> 
        <th scope="row"><%= t.id %></th> 
        <td>          
          <% begin %>
            <% source = t.raw_extraction.contributable %>
            <% case source %>
            <% when ConLink %>
              <%= "Names extracted from URI: #{source.uri}" %>
            <% when ConFile %>
              <%= "Names extracted from File: #{source.document.original_filename}" %>
            <% when ConTaxon %>
              <% case source.specific %>
              <% when SelectionTaxon %>
                <%= "Taxon: #{source.name}" %><br>
                <%= "Number of species: #{source.nb_species}" %><br>
                <%= "By: #{source.criterion}" %>
              <% when SubsetTaxon %>
                <%= "Taxon: #{source.name}" %><br>
                <%= "Has genome in NCBI: #{source.has_genome_in_ncbi}" %><br>
                <%= "In country: #{source.country.name}" %>
              <% else %>
                <%= "Taxon: #{source.name}" %>
              <% end %>
            <% end %>
          <% rescue %>
            <%= "" %>
          <% end %>
        </td>
        <td class="tree-status">
          <% case t.status %>
          <% when "resolved" %>
            Names acquired: click "Check name list" to approve list and get a tree
          <% when "unsucessfully-resolved" %>
            Sorry! We could not acquire a list of names!
          <% when "unsuccessfully-constructed" %>
            Sorry! We could not acquire a tree!
          <% when "completed" %>
            Tree acquired: click "View tree" to see it
          <% end %>
        </td>
        <td>
          <div class="check-status-manual-btn">
            <% if t.status == "completed" %>
              <%= link_to "Check status", "#", class: "check-status hide", id: t.id %>
            <% else %>
              <%= link_to "Check status", "#", class: "check-status", id:   t.id %>
            <% end %>
          </div>
          <div class="action-prune">
            <% if t.status == "resolved" %>
              <%= link_to "Check name list", edit_tree_path(t.id) %>
            <% end %>
          </div>
          <div class="action-view">
            <% if t.status == "completed" %>
              <%= link_to "View tree", tree_path(t.id) %>
            <% else %>
              <%= link_to "View tree", tree_path(t.id), class: "hide" %>
            <% end %>
          </div>
          <div class="action-delete">
            <%= link_to "Delete job", tree_path(t.id), method: :delete, data: {confirm: "Are you sure?"} %>
          </div>
        </td> 
      </tr> 
    <% end %>
  </tbody>
</table>
         
<script type="text/javascript">
$(document).ready(function() {
  var processing_trees = <%= @processing %>;
  
  Notification.requestPermission();
  function spawnNotification(theBody,theIcon,theTitle) {
    var options = {
        body: theBody,
        icon: theIcon
    }
    var n = new Notification(theTitle,options);
  }
  socket = new WebSocket("ws://" + window.location.host + "/track")

  socket.onopen = function(event) {
    for (i=processing_trees.length-1; i>=0 ; i--) {
      socket.send(processing_trees[i]);
      $("#" + i).parents("td").siblings('.tree-status').html("<span class='glyphicon glyphicon-refresh glyphicon-refresh-animate'></span>");
    }
  } 
  
  socket.onmessage = function(event) {
    data = JSON.parse(event.data);
    if(event.data.length) {
      // Change status of tree in view
      $("#" + data["tree_id"]).parents("td").siblings('.tree-status').html(tree_status(data["status"]));
      
      if (data["status"] == "completed") {        
        // Remove the tree that "completed" in processing_trees 
        index = processing_trees.indexOf(parseInt(data["tree_id"]));
        if (index > -1) {
          processing_trees.splice(index, 1);
        }
        
        // Hide "check status" btn
        $("#" + data["tree_id"]).parents("td").find('.check-status').addClass("hide");
        
        // Display "view tree" btn
        $("#" + data["tree_id"]).parents("td").children('.action-view').children('.hide').removeClass("hide");
        
        // Send notification
        spawnNotification("Your tree is ready to view", "http://www.cs.nmsu.edu/phylotastic/images/logo_huge.png", "Tree #" + data["tree_id"] + " is " + data["status"]);        
      } else if (data["status"] == "resolved") {
        $("#" + data["tree_id"]).parents("td").children('.action-prune').html("<a href='/trees/" + data["tree_id"] + "/edit'>Check name list</a>");
        
        // Send notification
        spawnNotification("To proceed, choose 'Check name list' in the Jobs table.", "http://www.cs.nmsu.edu/phylotastic/images/logo_huge.png", "Names have been acquired for job #" + data["tree_id"]);
      }
    }
  }

  $(".check-status").click(function(event) {
    event.preventDefault();
    params = $(this).attr('id');
    socket.send(params);
    $("#" + params).parents("td").siblings('.tree-status').html("<span class='glyphicon glyphicon-refresh glyphicon-refresh-animate'></span>");
  })
  
  function tree_status(s) {
    var msg;
    switch(s) {
      case "resolved":
        msg = "Names acquired: click \"verify names\" to approve list and get a tree";
        break;
      case "unsucessfully-resolved":
        msg = "Sorry! We could not acquire a list of names!";
        break;
      case "unsuccessfully-constructed":
        msg = "Sorry! We could not acquire a tree!";
        break;
      case "completed":
        msg = "Tree acquired: click \"View tree\" to see it";
        break;
    }
    return msg;
  }
});


</script>