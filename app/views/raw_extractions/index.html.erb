<% provide(:title, "Home") %>

<div class="row">
  <div class="col-md-3">
    <div class="list-selection">
      <%= render partial: "my_lists", locals: { my_lists: @my_lists,
                                           cfiles: @cfiles,
                                           ofiles: @ofiles,
                                           clinks: @clinks,
                                           ctaxons: @ctaxons,
                                           my_failed_lists: @my_failed_lists
                                           # my_subcribing_lists: @my_subcribing_lists 
                                           }%>

    </div>
    
    <div class="list-selection">
      <%= render partial: "public_lists", locals: { public_lists: @public_lists } %>
    </div>
  </div>
  
  <div class="col-md-9" id="ra-holder">
    <div class="col-md-9" id="ra-content">
      <p style="font-size: 150%; font-weight: bold;">
        Welcome to the Phylotastic web portal!
      </p>
      <p>
        The portal makes a tree from a list of species names. Choose from the "Make a new list" menu (at right) to
        <ul>
          <li>upload your list (one name per line or DwC-A)</li>
          <li>extract names from a document (PDF, .docx, etc)</li>
          <li>extract names from a web page</li>
          <li>choose a taxon (e.g., Felidae) and sample from that</li>
        </ul>
      
        If you don't have any lists of your own, choose a pre-made example from "Public Lists".
      </p>
      <p>
        To find out more, go to <%= link_to "Help", static_pages_help_path %>.
      </p>
    
      <%= image_tag("welcome.png", alt: "welcome", width: "100%", id: "welcome-img") %>
    
    </div>
  
    <div class="col-md-3">
      <div id="nav-list" class="hide">
      </div>
      <%= render partial: "creation_nav" %>  
    </div>  
  </div>
</div>

<script>
$(document).ready(function() {
  
    // $(".table-scroll" ).scrollTop( 300 );
  
  if("<%= params[:type] %>" != "") {
    if("<%= params[:jid] %>" == "") {
      $("#<%= params[:type] %>-<%= params[:id] %>").click();
      <% if !user_signed_in? %>
        <% if params[:type] == "ct" %>
          $("#ra-content").append('<%= link_to "a", con_taxon_path(params[:id]), remote: true, class:"hide", id: "ct-#{params[:id]}" %>');
          $("#ct-<%= params[:id] %>").click();
        <% end %>      
      <% end %>
    } else {
      socket = new WebSocket("ws://" + window.location.host + "/raw_extractions/checking_status?id=" + "<%= params[:id]%>" + "&type=" + "<%= params[:type] %>" + "&jid=" + "<%=params[:jid] %>");

      socket.onmessage = function(event) {
        if(event.data.length) {
          d = JSON.parse(event.data)
          console.log(d);
          if(d["status"] == "complete") {
            <% if user_signed_in? %>
              $("#<%= params[:type] %>-<%= params[:id] %>").click();   
            <% else %>
              <% case params[:type] %>
              <% when "cl" %>
                <% l = ConLink.find(params[:id]) %>
                $("#my-lists").append('<%= link_to l.name, con_link_path(params[:id]), remote: true, class:"list-group-item", id: "cl-#{params[:id]}" %>');
                $("#cl-<%= params[:id] %>").on("click", function() {
                    $(".list-group-item").removeClass("active");
                    $(this).addClass("active");
                    $('#ra-content').html("<div class='center'><img src='<%= image_path("loading-icon.gif") %>'></div>");
                    $('#nav-list').html("");
                  })
                $("#cl-<%= params[:id] %>").click();
              <% when "cf" %>
                <% f = ConFile.find(params[:id]) %>
                $("#my-lists").append('<%= link_to f.name, con_file_path(params[:id]), remote: true, class:"list-group-item", id: "cf-#{params[:id]}" %>');
                $("#cf-<%= params[:id] %>").on("click", function() {
                  $(".list-group-item").removeClass("active");
                  $(this).addClass("active");
                  $('#ra-content').html("<div class='center'><img src='<%= image_path("loading-icon.gif") %>'></div>");
                  $('#nav-list').html("");
                })
                $("#cf-<%= params[:id] %>").click();
              <% end %>
            <% end %>
          }
          if(d["status"] == "failed") {
            $("#<%= params[:type] %>-<%= params[:id] %>").click(); 
          }
        }
      }
        
    }
  }
  
  
  $(".list-group-item").on("click", function() {
    $(".list-group-item").removeClass("active");
    $(this).addClass("active");
    $('#ra-content').html("<div class='center'><img src='<%= image_path("loading-icon.gif") %>'></div>");
    $('#nav-list').html("");
  })
})

</script>